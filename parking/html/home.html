<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>首页</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!--标准mui.css-->
    <link rel="stylesheet" href="../css/mui.min.css">
	<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
    <link rel="stylesheet" href="../css/app.css">
	
	<style type="text/css">
        html,
        body, .mui-content {
            background: #FFF;
            height: 100%;
        }
		.head_icon{width: 30px; height: 30px; border-radius: 50%; top: 6px; right: 10px;}
		
		.item_wrap{margin-left: 4%; width: 92%; font-size: 12px; color: #999;}
		.item_wrap .title{margin-bottom: 10px;}
		.item_wrap .item{position: relative;background: #F2F2F2;height: 40px;}
		.item_wrap .item div{height: 100%;  display: inline-block; width: 40%;position: absolute; }
		.item_wrap .item input{border:none;height: 40px;background: #F2F2F2;color: #000000; width: 60%;}
		::-webkit-input-placeholder{color: #999999;font-size: 14px;}
		::-webkit-textarea-placeholder{color: #999999;font-size: 14px;}
		.item_wrap .item img{ width: 17px; height: 15px; position: absolute; right: 15px; top: 12px; }
		
		.item_wrap .item_select{border: 1px solid #E0E0E0; border-radius: 3px; height: 40px; padding: 0px 15px;}
		.item_wrap .item_select img{width: 12px; height: 6px;}
		.item_wrap .item_select .text{color: #000; font-size: 15px;}
		
		textarea{background: #F2F2F2; height: 85px; border:none;color: #000;}
		
		
		.upload_img_wrap{width: 32%;position: relative;margin-right: 1%;
				padding: 1%;box-sizing: border-box;} 
			
		.upload_img_wrap .img_btn{width: 100%;max-height: 1rem;}
			
		.upload_img_wrap .del_btn{position: absolute;top: -0.05rem;
				right: -0rem;width: 0.2rem;height: 0.2rem;z-index: 10;}
				
		.btn_wrap{width: 90%;background: #0B2A47;color: #FFF; height: 50px; margin: 20px 5% 50px;}
		.btn_wrap button{height: 50px; line-height: 50px; text-align: center; color: #FFFFFF; background-color: transparent;}
					
		.print_btn{width: 90%;background: #EC9924;color: #FFF; height: 50px; margin: 80px 5% 0px;}
    </style>
	
</head>

<body>

    <header class="mui-bar mui-bar-nav">
        <a class=" mui-icon mui-icon-left-nav mui-pull-left mui-action-back"></a>
        
        <h1 class="mui-title">录入</h1>
        <!-- <img src="../images/splash.png"  class="head_icon"/> -->
    </header>

    <div class="mui-content">
		<div class="item_wrap" style="margin-top: 30px;">
			<div class="title">车牌号</div>
			<div class="item">
				<input type="text" placeholder="请输入车牌号" class="car_num">
				<div id="take_photo">
					<img src="../images/camera.png" >
				</div>
				
			</div>
		</div>
		
		<div class="item_wrap car_select" style="margin-top: 10px;">
			<div class="title">违章车型</div>
			<div class="item_select row_between">
				<span class="text" id="car_text"></span>
				<img src="../images/arraw_down.png">
			</div>
		</div>
		
		<div class="item_wrap name_select" style="margin-top: 10px;">
			<div class="title">路队中段</div>
			<div class="item_select row_between">
				<span class="text" id="name_text"></span>
				<img src="../images/arraw_down.png">
			</div>
		</div>
		
		<div class="item_wrap road_select" style="margin-top: 10px;">
			<div class="title">拍照路段</div>
			<div class="item_select row_between">
				<span class="text" id="road_text"></span>
				<img src="../images/arraw_down.png">
			</div>
		</div>
		
		<div class="item_wrap time_refresh" style="margin-top: 10px;">
			<div class="title">拍照时间</div>
			<div class="item_select row_between">
				<span class="text time_value"></span>
				<img src="../images/refresh.png" style="width: 17px; height: 15px;">
			</div>
		</div>
		
		<div class="item_wrap" style="margin-top: 10px;">
			<div class="title">备注信息</div>
			<textarea placeholder="请输入备注信息" class="remark"></textarea>
		</div>
		
		<div class="item_wrap" style="margin-top: 10px;">
			<div class="title">拍照中队</div>
			<div class="item">
				<input class="take_photo_road" type="text" readonly style="color: #999;">
			</div>
		</div>
		
		<div class="item_wrap" style="margin-top: 10px;">
			<div class="title">拍照人员</div>
			<div class="item">
				<input class="take_photo_name" type="text" readonly style="color: #999;">
			</div>
		</div>
		
		<div class="item_wrap" style="margin-top: 10px;">
			<div class="title">违章图片</div>
			<div class="row img_wrap">
					
			</div>
		</div>
		
		<button type="button" class="mui-btn mui-btn-link print_btn">打印</button>
		<button type="button" class="mui-btn mui-btn-link btn_wrap" onclick="recordAdd();">上传</button>
		
		
    </div>

</body>
<script src="../js/mui.js"></script>
<script src="../js/mui.picker.min.js"></script>
<script src="../js/jquery-2.1.1.min.js"></script>
<script src="../js/app.js"></script>
<script src="../js/myStorage.js"></script>
<script type='text/javascript'>
	mui.init();
	var main;
	var Intent;
	var intent;
	var packname = "com.LiekeNet.DaTongCGJ";
	mui.plusReady(function() {
		
		main = plus.android.runtimeMainActivity();
		Intent = plus.android.importClass("android.content.Intent");
		intent = new Intent(main.getIntent());
		addImage();
		getTeams();
		console.log(myStorage.getItem("userinfo").username);
		$(".take_photo_name").val(myStorage.getItem("userinfo").username);
	});
    $(".time_value").html(getDateTime());
	$(".car_num").val("豫A12345")
	
	// mui(".mui_content").on('tap', '.btn_wrap', function() {
	// 	
	// 	
	// 	recordAdd();
	// 	
	// });
	
	// 上传
	function recordAdd(){
		console.log("9999");
		console.log($(".car_num").val());
		if(!$(".car_num").val()){
			mui.toast("请输入车牌号");
			return;
		}
		if(!$(".remark").val()){
			mui.toast("请输入备注信息");
			return;
		}
		
		if(images.length != 2){
			mui.toast("请上传两种违章图片");
			return;
		}
		
		var imagesTemp = [];
		images.map(function(item){
			imagesTemp.push(item.split(Global.imgUrl)[1]);
		})
		
		var params = {
			license_plate: $(".car_num").val(),
			photo_time: $(".time_value").html(),
			road_id: road_value,
			car_type: car_value,
			username: myStorage.getItem("userinfo").username,
			remark: $(".remark").val(),
			imgs: imagesTemp,
			token:myStorage.getItem("token")
		};
		Global.commonAjax({
				url: "index/record_add",
				method: 'POST',
				data: params
			},
			function(data) {
				console.log(data);
			},
			function(err, code) {
				mui.toast(err);
			}
		)
	}
	
	var images = [];
	var carPickerList = [];
	var namePickerList = [];
	var roadPickerList = [];
	var carPicker = new mui.PopPicker();
	var namePicker = new mui.PopPicker();
	var roadPicker = new mui.PopPicker();
	var car_value = "";
	var name_value = "";
	var road_value = "";
	
	
	
	// 01 小型车，02 大型车，51 新能源小型车，52 新能源大型车
	carPickerList = [{text: '小型车', value: "01"}, {text: '大型车', value: "02"},{text: '新能源小型车', value: "51"},{text: '新能源大型车', value: "52"}];
	carPicker.setData(carPickerList);
	mui('#car_text')[0].innerHTML = carPickerList[0].text;
	car_value = carPickerList[0].value;
	
	//离开 解除打印机
	var mui_old_back = mui.back;
	mui.back = function() {
	    //plus.android.invoke(packname+".Tools", "disconnect", main);
		mui_old_back();
	}
	
	// 打印东西
	mui(".mui-content").on('tap', '.print_btn', function() {
		
		plus.android.invoke(packname+".Tools", "initPrint");
		var btnArray = ['取消', '确定'];
		mui.confirm('确定是否打印', '提示', btnArray, function(e) {
		    if (e.index == 1) {
				actionPrint();
		    }
		
		});
		
	});
	
	function actionPrint(){
		var callBack = plus.android.implements(packname+".Tools$CallBack", {
			"success": function() {
				
				if (callback) {
					//mui.toast("打印机初始化未完成");
				}
			},
			"failure": function() {
				console.log("4444444")
				if (fail) {
					mui.toast("打印机初始化未完成");
				}
			}
		});
		plus.android.invoke(packname+".Tools", "print", "1234womenhao我们好", callBack);
	}
	
	
	mui(".car_select").on('tap', 'div', function() {
		document.activeElement.blur();
		setTimeout(() => {
			carPicker.show(function(SelectedItem) {
			    console.log(SelectedItem[0].text);
			    mui('#car_text')[0].innerHTML = SelectedItem[0].text;
			    car_value = SelectedItem[0].value;
			})
		}, 500);
		
	})
	
	mui(".name_select").on('tap', 'div', function() {
		document.activeElement.blur();
		setTimeout(()=>{
			namePicker.show(function(SelectedItem) {
			    console.log(SelectedItem[0].text);
			    mui('#name_text')[0].innerHTML = SelectedItem[0].text;
			    name_value = SelectedItem[0].value;
				$(".take_photo_road").val(SelectedItem[0].text);
				getRoads(SelectedItem[0].value);
			})
		}, 500);
		
	})
	
	mui(".road_select").on('tap', 'div', function() {
		document.activeElement.blur();
		setTimeout(() => {
			roadPicker.show(function(SelectedItem) {
			    console.log(SelectedItem[0].text);
			    mui('#road_text')[0].innerHTML = SelectedItem[0].text;
			    road_value = SelectedItem[0].value;
			})
		}, 500)
	})
	
	mui(".time_refresh").on('tap', 'div', function() {
		$(".time_value").html(getDateTime());
	})
	
	mui(".item").on('tap', '#take_photo', function() {
		$(".time_value").html(getDateTime());
		document.activeElement.blur();
		checkPermissionPhoto(goToAndroid, null);
	});
	//点击检查权限
	function checkPermissionPhoto(callback, fail) {
		plus.android.invoke(packname+".Tools", "initUtils", main);
		var callBack = plus.android.implements(packname+".Tools$CallBack", {
			"success": function() {
				console.log("3333333")
				if (callback) {
					callback();
				}
			},
			"failure": function() {
				console.log("4444444")
				if (fail) {
					fail();
				}
			}
		});
		plus.android.invoke(packname+".Tools", "permission", ["android.permission-group.CAMERA"], callBack);
	}

	
	function goToAndroid(){
		intent.setClassName(main, "com.frank.plate.activity.PreviewActivity");
		intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
		main.startActivityForResult(intent, 19);
		main.onActivityResult = function(request, code, data) {
			console.log("555555"+code)
			if ( (request == 19) && (code == -1)) {
				console.log("6666666");
				var result = data.getStringExtra("result");
				console.log(result);
				$(".car_num").val(result);
				plus.screen.unlockOrientation();
				plus.screen.lockOrientation("portrait-primary"); 
			}

		}
				
	}
	
	var fileName = "temp.jpg";
	mui(".img_wrap").on('tap', '.add_btn', function() {
		document.activeElement.blur();
		plus.nativeUI.actionSheet({
		    cancel: "取消",
		    buttons: [{
		        title: "拍照"
		    }, {
		        title: "从相册中选择"
		    }]
		}, function(e) { //1 是拍照  2 从相册中选择
		    switch (e.index) {
		        case 1:
		            appendByCamera();
		            break;
		        case 2:
		            appendByGallery();
		            break;
		    }
		});
	});
	// 拍照添加文件
	function appendByCamera() {
	    plus.camera.getCamera().captureImage(function(e) {
	        console.log("e is" + e);
	        plus.io.resolveLocalFileSystemURL(e, function(entry) {
	            var path = entry.toLocalURL();
	            var pathList = path.split("/");
	            fileName = pathList[pathList.length-1];
	            uploadFile(path);
	
	        }, function(e) {
	            mui.toast("读取拍照文件错误：" + e.message);
	        });
	
	    });
	}
	
	function appendByGallery() {
	    plus.gallery.pick(function(path) {
			var pathList = path.split("/");
			fileName = pathList[pathList.length-1];
	        uploadFile(path);
	
	    });
	}
	
	function uploadFile (path) {
		Global.showLoading();
	    var task = plus.uploader.createUpload(Global.baseUrl+"upfiles/upload",
	        {method:"POST"},
	        function(t,status){ //上传完成
				Global.hideLoading();
	            if(status==200){
	            	console.log("上传成功："+t.responseText);
	            	console.log("上传成功---："+JSON.parse(t.responseText).code);
					if(JSON.parse(t.responseText).code == 200){
						console.log(Global.imgUrl+JSON.parse(t.responseText).data.url)
						images.push(Global.imgUrl+JSON.parse(t.responseText).data.url);
						addImage();
					}
					
	            }else{
	                console.log("上传失败："+status);
	            }
	        }
	    );
	    //添加其他参数
	    task.addData("token",myStorage.getItem("token"));
        // 页面中要上传的 图片路径
	    task.addFile(path,{key:path});
	    task.start();
	}
	
	function getDateTime(){
		var date = new Date();
		var year = date.getFullYear();
		var month = date.getMonth()+1;
		if(parseInt(month) < 10){
			month = "0"+month;
		}
		var day = date.getDate();
		if(parseInt(day) < 10){
			day = "0"+day;
		}
		var hour = date.getHours();
		if(parseInt(hour) < 10){
			hour = "0"+hour;
		}
		var minute = date.getMinutes();
		if(parseInt(minute) < 10){
			minute = "0"+minute;
		}
		var second = date.getSeconds();
		if(parseInt(second) < 10){
			second = "0"+second;
		}
		return year+'-'+month+'-'+day+' '+hour+':'+minute+':'+second;
	}
	
	
	function addImage(){
			var html = '';
			$(".img_wrap").html(""); 
			console.log(images);
			if(images){
				images.map(function(item, index){
					html += '<div class="upload_img_wrap">'+
								'<img src="'+item+'" class="img_btn">'+
								'<img src="../images/upload_del_icon.jpg" class="del_btn" data-index="'+index+'">'+
							'</div>';
				});
			}
			
			if(images==undefined || images.length < 2){
				html += '<div class="upload_img_wrap add_btn">'+
							'<img src="../images/upload_icon.jpg" class="img_btn">'+
						'</div>';
			}
			
			
			$(".img_wrap").append(html);
			
			mui(".upload_img_wrap").on('tap', '.del_btn', function() {
				console.log("000")
				var index = $(this).data("index");
				images.splice(index, 1);
				addImage();
			});
			
		}
		
		// 获取中队
		function getTeams(){
			Global.commonAjax({
					url: "index/team",
					method: 'POST',
					data: {"token":myStorage.getItem("token")}
				},
				function(data) {
					console.log(data);
					namePickerList = [];
					data.map(function(item, index){
						namePickerList.push({text: item.level_name, value: item.level_id})
					});
					namePicker.setData(namePickerList);
					
					mui('#name_text')[0].innerHTML = namePickerList[0].text;
					name_value = namePickerList[0].value;
					$(".take_photo_road").val(namePickerList[0].text);
					getRoads(namePickerList[0].value);
				},
				function(err, code) {
					mui.toast(err);
				}
			)
		}
			
		// 获取路段
		function getRoads(teamId){
			Global.commonAjax({
					url: "index/roads",
					method: 'POST',
					data: {"token":myStorage.getItem("token"), "teamId": teamId}
				},
				function(data) {
					console.log(data);
					roadPickerList = [];
					data.map(function(item, index){
						roadPickerList.push({text: item.road_name, value: item.road_id})
					});
					roadPicker.setData(roadPickerList);
					mui('#road_text')[0].innerHTML = roadPickerList[0].text;
					road_value = roadPickerList[0].value;
				},
				function(err, code) {
					mui.toast(err);
				}
			)
		}
		
</script>

</html>